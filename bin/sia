#! /usr/bin/env php
<?php
    require __DIR__ . '/../vendor/autoload.php';

    set_exception_handler(
        function($exception) {
            writeln();

            writeln(
                '%s:',
                get_class($exception)
            );

            writeln($exception->getMessage());
            writeln();
        }
    );

    use Ulrichsg\Getopt;

    $getopt = new Getopt(
        array(
            array('i', 'input',  Getopt::REQUIRED_ARGUMENT, 'Documentation input directory'),
            array('o', 'output', Getopt::REQUIRED_ARGUMENT, 'Output directory'),
            array('t', 'theme',  Getopt::OPTIONAL_ARGUMENT, 'Theme (default=minimalistic)'),
        )
    );

    $getopt->parse();

    $input  = rtrim($getopt->getOption('i'), DIRECTORY_SEPARATOR);
    $output = rtrim($getopt->getOption('o'), DIRECTORY_SEPARATOR);
    $theme  = __DIR__ . '/../themes/' . ($getopt->getOption('t') ?: 'minimalistic');

    if(!file_exists($input)) {
        throw new RuntimeException("Input directory \"$input\" does not exist.");
    }

    if(!file_exists($output)) {
        throw new RuntimeException("Output directory \"$output\" does not exist.");
    }

    if(!file_exists($theme)) {
        throw new RuntimeException("Theme directory \"$theme\" does not exist.");
    }

    $renderer = \Skriv\Markup\Renderer::factory();

    foreach(glob($input . '/*.skriv') as $inputFile) {
        $outputFile = $output . '/' . str_replace('.skriv', '.html', basename($inputFile));

        writeln(
            'Convert %s into %s',
            $inputFile,
            $outputFile
        );

        $page = str_replace(
            array(
                '<div class="info">',
                '<div class="warning">',
            ),
            array(
                '<div class="info"><i class="icon-info-sign icon-4x pull-left"></i>',
                '<div class="info"><i class="icon-exclamation-sign icon-4x pull-left"></i>',
            ),
            $renderer->render(
                file_get_contents($inputFile)
            )
        );

        preg_match('#<h1[^<]*>(.*)</h1>#u', $page, $result);
        $title = isset($result[1]) ? $result[1] : '';

        $toc = '';

        file_put_contents(
            $outputFile,
            str_replace(
                array(
                    '{title}',
                    '{page}',
                    '{toc}',
                ),
                array(
                    $title,
                    $page,
                    $toc,
                ),
                file_get_contents($theme . '/page.html')
            )
        );
    }

    foreach(array('css', 'js', 'javascript', 'javascripts', 'img', 'image', 'images', 'font', 'fonts') as $dir) {
        exec("rm -rf $output/$dir");

        if(file_exists("$theme/$dir")) {
            exec("cp -rf $theme/$dir $output/");
        }
    }


    function writeln() {
        $args = func_get_args();

        if(!isset($args[0])) {
            $args[0] = '';
        }

        $args[0] .= PHP_EOL;

        call_user_func_array('write', $args);
    }

    function write() {
        $args = func_get_args();

        vprintf($args[0], array_slice($args, 1));
    }